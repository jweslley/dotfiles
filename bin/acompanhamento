#!/bin/sh

CALENDAR_ICS=$1

DATE_FILE="$CALENDAR_ICS.date.aux"
MASS_FILE="$CALENDAR_ICS.kg.aux"
DATA_FILE="$CALENDAR_ICS.dat.aux"
PNG_FILE="$CALENDAR_ICS.png"

echo "processing $CALENDAR_ICS"

grep SUMMARY $CALENDAR_ICS | cut -d: -f 2 | cut -d" "  -f1 > $MASS_FILE
grep CREATED $CALENDAR_ICS | cut -d: -f 2 | cut -d" "  -f1 | cut -dT -f1 > $DATE_FILE
paste $DATE_FILE $MASS_FILE > $DATA_FILE

echo "
  png(filename=\"$PNG_FILE\", bg=\"white\")
  data = read.table(\"$DATA_FILE\")
  data\$V1 <- as.Date(strptime(data\$V1, \"%Y%m%d\"))
  data <- data[order(data\$V1), ]
  plot(data, type=\"l\", bty=\"n\", ylab=\"Peso (Kg)\", xlab=\"Data\", main=\"Acompanhamento\")
  " | R --slave && echo "generated $PNG_FILE"

rm $CALENDAR_ICS.*.aux
